CREATE TABLE taxi_trips_cleaned AS
SELECT 
    VendorID,
    lpep_pickup_datetime,
    lpep_dropoff_datetime,
    COALESCE(store_and_fwd_flag, 'N') AS store_and_fwd_flag,
    RatecodeID,
    PULocationID,
    DOLocationID,
    -- Handle zero or null passenger counts
    CASE 
        WHEN passenger_count IS NULL OR passenger_count = 0 THEN 1
        ELSE passenger_count
    END AS passenger_count,
    -- Filter out unreasonable trip distances
    CASE
        WHEN trip_distance < 0 OR trip_distance > 100 THEN NULL
        ELSE trip_distance
    END AS trip_distance,
    -- Convert null monetary values to zero
    COALESCE(fare_amount, 0) AS fare_amount,
    COALESCE(extra, 0) AS extra,
    COALESCE(mta_tax, 0) AS mta_tax,
    COALESCE(tip_amount, 0) AS tip_amount,
    COALESCE(tolls_amount, 0) AS tolls_amount,
    -- Calculate trip duration in minutes
    (UNIX_TIMESTAMP(lpep_dropoff_datetime) - UNIX_TIMESTAMP(lpep_pickup_datetime)) / 60 AS trip_duration_minutes, 
    COALESCE(improvement_surcharge, 0) AS improvement_surcharge,
    COALESCE(total_amount, 0) AS total_amount,
    payment_type,
    trip_type,
    COALESCE(congestion_surcharge, 0) AS congestion_surcharge
FROM 
    taxi_trips
WHERE
    -- Filter out missing timestamps or invalid trip duration
    lpep_pickup_datetime IS NOT NULL AND
    lpep_dropoff_datetime IS NOT NULL AND
    lpep_dropoff_datetime > lpep_pickup_datetime AND

    -- Filter out negative values
    (fare_amount >= 0 OR fare_amount IS NULL) AND
    (extra >= 0 OR extra IS NULL) AND
    (mta_tax >= 0 OR mta_tax IS NULL) AND
    (tip_amount >= 0 OR tip_amount IS NULL) AND
    (tolls_amount >= 0 OR tolls_amount IS NULL) AND
    (improvement_surcharge >= 0 OR improvement_surcharge IS NULL) AND
    (total_amount >= 0 OR total_amount IS NULL) AND
    (congestion_surcharge >= 0 OR congestion_surcharge IS NULL);

